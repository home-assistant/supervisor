{"version":3,"file":"6c342f77.js","mappings":";AAirBA","sources":["webpack://home-assistant-frontend/./src/components/ha-target-picker.ts"],"sourcesContent":["// @ts-ignore\nimport chipStyles from \"@material/chips/dist/mdc.chips.min.css\";\nimport \"@material/mwc-button/mwc-button\";\nimport \"@material/mwc-menu/mwc-menu-surface\";\nimport {\n  mdiClose,\n  mdiDevices,\n  mdiPlus,\n  mdiSofa,\n  mdiUnfoldMoreVertical,\n} from \"@mdi/js\";\nimport \"@polymer/paper-tooltip/paper-tooltip\";\nimport { ComboBoxLightOpenedChangedEvent } from \"@vaadin/combo-box/vaadin-combo-box-light\";\nimport { HassEntity, HassServiceTarget } from \"home-assistant-js-websocket\";\nimport { css, CSSResultGroup, html, LitElement, unsafeCSS, nothing } from \"lit\";\nimport { customElement, property, query, state } from \"lit/decorators\";\nimport { classMap } from \"lit/directives/class-map\";\nimport { ensureArray } from \"../common/array/ensure-array\";\nimport { fireEvent } from \"../common/dom/fire_event\";\nimport { stopPropagation } from \"../common/dom/stop_propagation\";\nimport { computeDomain } from \"../common/entity/compute_domain\";\nimport { computeStateName } from \"../common/entity/compute_state_name\";\nimport { isValidEntityId } from \"../common/entity/valid_entity_id\";\nimport {\n  computeDeviceName,\n  DeviceRegistryEntry,\n} from \"../data/device_registry\";\nimport { EntityRegistryDisplayEntry } from \"../data/entity_registry\";\nimport { HomeAssistant } from \"../types\";\nimport \"./device/ha-device-picker\";\nimport type { HaDevicePickerDeviceFilterFunc } from \"./device/ha-device-picker\";\nimport \"./entity/ha-entity-picker\";\nimport type { HaEntityPickerEntityFilterFunc } from \"./entity/ha-entity-picker\";\nimport \"./ha-area-picker\";\nimport \"./ha-icon-button\";\nimport \"./ha-input-helper-text\";\nimport \"./ha-svg-icon\";\n\n@customElement(\"ha-target-picker\")\nexport class HaTargetPicker extends LitElement {\n  @property({ attribute: false }) public hass!: HomeAssistant;\n\n  @property({ attribute: false }) public value?: HassServiceTarget;\n\n  @property() public label?: string;\n\n  @property() public helper?: string;\n\n  /**\n   * Show only targets with entities from specific domains.\n   * @type {Array}\n   * @attr include-domains\n   */\n  @property({ type: Array, attribute: \"include-domains\" })\n  public includeDomains?: string[];\n\n  /**\n   * Show only targets with entities of these device classes.\n   * @type {Array}\n   * @attr include-device-classes\n   */\n  @property({ type: Array, attribute: \"include-device-classes\" })\n  public includeDeviceClasses?: string[];\n\n  @property() public deviceFilter?: HaDevicePickerDeviceFilterFunc;\n\n  @property() public entityFilter?: HaEntityPickerEntityFilterFunc;\n\n  @property({ type: Boolean, reflect: true }) public disabled = false;\n\n  @property({ type: Boolean }) public addOnTop = false;\n\n  @state() private _addMode?: \"area_id\" | \"entity_id\" | \"device_id\";\n\n  @query(\"#input\") private _inputElement?;\n\n  @query(\".add-container\", true) private _addContainer?: HTMLDivElement;\n\n  private _opened = false;\n\n  protected render() {\n    if (this.addOnTop) {\n      return html` ${this._renderChips()} ${this._renderItems()} `;\n    }\n    return html` ${this._renderItems()} ${this._renderChips()} `;\n  }\n\n  private _renderItems() {\n    return html`\n      <div class=\"mdc-chip-set items\">\n        ${this.value?.area_id\n          ? ensureArray(this.value.area_id).map((area_id) => {\n              const area = this.hass.areas![area_id];\n              return this._renderChip(\n                \"area_id\",\n                area_id,\n                area?.name || area_id,\n                undefined,\n                mdiSofa\n              );\n            })\n          : \"\"}\n        ${this.value?.device_id\n          ? ensureArray(this.value.device_id).map((device_id) => {\n              const device = this.hass.devices![device_id];\n              return this._renderChip(\n                \"device_id\",\n                device_id,\n                device ? computeDeviceName(device, this.hass) : device_id,\n                undefined,\n                mdiDevices\n              );\n            })\n          : \"\"}\n        ${this.value?.entity_id\n          ? ensureArray(this.value.entity_id).map((entity_id) => {\n              const entity = this.hass.states[entity_id];\n              return this._renderChip(\n                \"entity_id\",\n                entity_id,\n                entity ? computeStateName(entity) : entity_id,\n                entity\n              );\n            })\n          : \"\"}\n      </div>\n    `;\n  }\n\n  private _renderChips() {\n    return html`\n      <div class=\"mdc-chip-set add-container\">\n        <div\n          class=\"mdc-chip area_id add\"\n          .type=${\"area_id\"}\n          @click=${this._showPicker}\n        >\n          <div class=\"mdc-chip__ripple\"></div>\n          <ha-svg-icon\n            class=\"mdc-chip__icon mdc-chip__icon--leading\"\n            .path=${mdiPlus}\n          ></ha-svg-icon>\n          <span role=\"gridcell\">\n            <span role=\"button\" tabindex=\"0\" class=\"mdc-chip__primary-action\">\n              <span class=\"mdc-chip__text\"\n                >${this.hass.localize(\n                  \"ui.components.target-picker.add_area_id\"\n                )}</span\n              >\n            </span>\n          </span>\n        </div>\n        <div\n          class=\"mdc-chip device_id add\"\n          .type=${\"device_id\"}\n          @click=${this._showPicker}\n        >\n          <div class=\"mdc-chip__ripple\"></div>\n          <ha-svg-icon\n            class=\"mdc-chip__icon mdc-chip__icon--leading\"\n            .path=${mdiPlus}\n          ></ha-svg-icon>\n          <span role=\"gridcell\">\n            <span role=\"button\" tabindex=\"0\" class=\"mdc-chip__primary-action\">\n              <span class=\"mdc-chip__text\"\n                >${this.hass.localize(\n                  \"ui.components.target-picker.add_device_id\"\n                )}</span\n              >\n            </span>\n          </span>\n        </div>\n        <div\n          class=\"mdc-chip entity_id add\"\n          .type=${\"entity_id\"}\n          @click=${this._showPicker}\n        >\n          <div class=\"mdc-chip__ripple\"></div>\n          <ha-svg-icon\n            class=\"mdc-chip__icon mdc-chip__icon--leading\"\n            .path=${mdiPlus}\n          ></ha-svg-icon>\n          <span role=\"gridcell\">\n            <span role=\"button\" tabindex=\"0\" class=\"mdc-chip__primary-action\">\n              <span class=\"mdc-chip__text\"\n                >${this.hass.localize(\n                  \"ui.components.target-picker.add_entity_id\"\n                )}</span\n              >\n            </span>\n          </span>\n        </div>\n        ${this._renderPicker()}\n      </div>\n      ${this.helper\n        ? html`<ha-input-helper-text>${this.helper}</ha-input-helper-text>`\n        : \"\"}\n    `;\n  }\n\n  private _showPicker(ev) {\n    this._addMode = ev.currentTarget.type;\n  }\n\n  private _renderChip(\n    type: \"area_id\" | \"device_id\" | \"entity_id\",\n    id: string,\n    name: string,\n    entityState?: HassEntity,\n    iconPath?: string\n  ) {\n    return html`\n      <div\n        class=\"mdc-chip ${classMap({\n          [type]: true,\n        })}\"\n      >\n        ${iconPath\n          ? html`<ha-svg-icon\n              class=\"mdc-chip__icon mdc-chip__icon--leading\"\n              .path=${iconPath}\n            ></ha-svg-icon>`\n          : \"\"}\n        ${entityState\n          ? html`<ha-state-icon\n              class=\"mdc-chip__icon mdc-chip__icon--leading\"\n              .state=${entityState}\n            ></ha-state-icon>`\n          : \"\"}\n        <span role=\"gridcell\">\n          <span role=\"button\" tabindex=\"0\" class=\"mdc-chip__primary-action\">\n            <span class=\"mdc-chip__text\">${name}</span>\n          </span>\n        </span>\n        ${type === \"entity_id\"\n          ? \"\"\n          : html`<span role=\"gridcell\">\n              <ha-icon-button\n                class=\"expand-btn mdc-chip__icon mdc-chip__icon--trailing\"\n                tabindex=\"-1\"\n                role=\"button\"\n                .label=${this.hass.localize(\n                  \"ui.components.target-picker.expand\"\n                )}\n                .path=${mdiUnfoldMoreVertical}\n                hideTooltip\n                .id=${id}\n                .type=${type}\n                @click=${this._handleExpand}\n              ></ha-icon-button>\n              <paper-tooltip class=\"expand\" animation-delay=\"0\"\n                >${this.hass.localize(\n                  `ui.components.target-picker.expand_${type}`\n                )}</paper-tooltip\n              >\n            </span>`}\n        <span role=\"gridcell\">\n          <ha-icon-button\n            class=\"mdc-chip__icon mdc-chip__icon--trailing\"\n            tabindex=\"-1\"\n            role=\"button\"\n            .label=${this.hass.localize(\"ui.components.target-picker.remove\")}\n            .path=${mdiClose}\n            hideTooltip\n            .id=${id}\n            .type=${type}\n            @click=${this._handleRemove}\n          ></ha-icon-button>\n          <paper-tooltip animation-delay=\"0\"\n            >${this.hass.localize(\n              `ui.components.target-picker.remove_${type}`\n            )}</paper-tooltip\n          >\n        </span>\n      </div>\n    `;\n  }\n\n  private _renderPicker() {\n    if (!this._addMode) {\n      return nothing;\n    }\n    return html`<mwc-menu-surface\n      open\n      .anchor=${this._addContainer}\n      .corner=${\"BOTTOM_START\"}\n      @closed=${this._onClosed}\n      @opened=${this._onOpened}\n      @opened-changed=${this._openedChanged}\n      @input=${stopPropagation}\n      >${this._addMode === \"area_id\"\n        ? html`\n            <ha-area-picker\n              .hass=${this.hass}\n              id=\"input\"\n              .type=${\"area_id\"}\n              .label=${this.hass.localize(\n                \"ui.components.target-picker.add_area_id\"\n              )}\n              no-add\n              .deviceFilter=${this.deviceFilter}\n              .entityFilter=${this.entityFilter}\n              .includeDeviceClasses=${this.includeDeviceClasses}\n              .includeDomains=${this.includeDomains}\n              .excludeAreas=${ensureArray(this.value?.area_id)}\n              @value-changed=${this._targetPicked}\n              @click=${this._preventDefault}\n            ></ha-area-picker>\n          `\n        : this._addMode === \"device_id\"\n        ? html`\n            <ha-device-picker\n              .hass=${this.hass}\n              id=\"input\"\n              .type=${\"device_id\"}\n              .label=${this.hass.localize(\n                \"ui.components.target-picker.add_device_id\"\n              )}\n              .deviceFilter=${this.deviceFilter}\n              .entityFilter=${this.entityFilter}\n              .includeDeviceClasses=${this.includeDeviceClasses}\n              .includeDomains=${this.includeDomains}\n              .excludeDevices=${ensureArray(this.value?.device_id)}\n              @value-changed=${this._targetPicked}\n              @click=${this._preventDefault}\n            ></ha-device-picker>\n          `\n        : html`\n            <ha-entity-picker\n              .hass=${this.hass}\n              id=\"input\"\n              .type=${\"entity_id\"}\n              .label=${this.hass.localize(\n                \"ui.components.target-picker.add_entity_id\"\n              )}\n              .entityFilter=${this.entityFilter}\n              .includeDeviceClasses=${this.includeDeviceClasses}\n              .includeDomains=${this.includeDomains}\n              .excludeEntities=${ensureArray(this.value?.entity_id)}\n              @value-changed=${this._targetPicked}\n              @click=${this._preventDefault}\n              allow-custom-entity\n            ></ha-entity-picker>\n          `}</mwc-menu-surface\n    >`;\n  }\n\n  private _targetPicked(ev) {\n    ev.stopPropagation();\n    if (!ev.detail.value) {\n      return;\n    }\n    const value = ev.detail.value;\n    const target = ev.currentTarget;\n\n    if (target.type === \"entity_id\" && !isValidEntityId(value)) {\n      return;\n    }\n\n    target.value = \"\";\n    if (\n      this.value &&\n      this.value[target.type] &&\n      ensureArray(this.value[target.type]).includes(value)\n    ) {\n      return;\n    }\n    fireEvent(this, \"value-changed\", {\n      value: this.value\n        ? {\n            ...this.value,\n            [target.type]: this.value[target.type]\n              ? [...ensureArray(this.value[target.type]), value]\n              : value,\n          }\n        : { [target.type]: value },\n    });\n  }\n\n  private _handleExpand(ev) {\n    const target = ev.currentTarget as any;\n    const newDevices: string[] = [];\n    const newEntities: string[] = [];\n    if (target.type === \"area_id\") {\n      Object.values(this.hass.devices).forEach((device) => {\n        if (\n          device.area_id === target.id &&\n          !this.value!.device_id?.includes(device.id) &&\n          this._deviceMeetsFilter(device)\n        ) {\n          newDevices.push(device.id);\n        }\n      });\n      Object.values(this.hass.entities).forEach((entity) => {\n        if (\n          entity.area_id === target.id &&\n          !this.value!.entity_id?.includes(entity.entity_id) &&\n          this._entityRegMeetsFilter(entity)\n        ) {\n          newEntities.push(entity.entity_id);\n        }\n      });\n    } else if (target.type === \"device_id\") {\n      Object.values(this.hass.entities).forEach((entity) => {\n        if (\n          entity.device_id === target.id &&\n          !this.value!.entity_id?.includes(entity.entity_id) &&\n          this._entityRegMeetsFilter(entity)\n        ) {\n          newEntities.push(entity.entity_id);\n        }\n      });\n    } else {\n      return;\n    }\n    let value = this.value;\n    if (newEntities.length) {\n      value = this._addItems(value, \"entity_id\", newEntities);\n    }\n    if (newDevices.length) {\n      value = this._addItems(value, \"device_id\", newDevices);\n    }\n    value = this._removeItem(value, target.type, target.id);\n    fireEvent(this, \"value-changed\", { value });\n  }\n\n  private _handleRemove(ev) {\n    const target = ev.currentTarget as any;\n    fireEvent(this, \"value-changed\", {\n      value: this._removeItem(this.value, target.type, target.id),\n    });\n  }\n\n  private _addItems(\n    value: this[\"value\"],\n    type: string,\n    ids: string[]\n  ): this[\"value\"] {\n    return {\n      ...value,\n      [type]: value![type] ? ensureArray(value![type])!.concat(ids) : ids,\n    };\n  }\n\n  private _removeItem(\n    value: this[\"value\"],\n    type: string,\n    id: string\n  ): this[\"value\"] {\n    const newVal = ensureArray(value![type])!.filter(\n      (val) => String(val) !== id\n    );\n    if (newVal.length) {\n      return {\n        ...value,\n        [type]: newVal,\n      };\n    }\n    const val = { ...value }!;\n    delete val[type];\n    if (Object.keys(val).length) {\n      return val;\n    }\n    return undefined;\n  }\n\n  private _onClosed(ev) {\n    ev.stopPropagation();\n    ev.target.open = true;\n  }\n\n  private async _onOpened() {\n    if (!this._addMode) {\n      return;\n    }\n    await this._inputElement?.focus();\n    await this._inputElement?.open();\n    this._opened = true;\n  }\n\n  private _openedChanged(ev: ComboBoxLightOpenedChangedEvent) {\n    if (this._opened && !ev.detail.value) {\n      this._opened = false;\n      this._addMode = undefined;\n    }\n  }\n\n  private _preventDefault(ev: Event) {\n    ev.preventDefault();\n  }\n\n  private _deviceMeetsFilter(device: DeviceRegistryEntry): boolean {\n    const devEntities = Object.values(this.hass.entities).filter(\n      (entity) => entity.device_id === device.id\n    );\n\n    if (this.includeDomains) {\n      if (!devEntities || !devEntities.length) {\n        return false;\n      }\n      if (\n        !devEntities.some((entity) =>\n          this.includeDomains!.includes(computeDomain(entity.entity_id))\n        )\n      ) {\n        return false;\n      }\n    }\n\n    if (this.includeDeviceClasses) {\n      if (!devEntities || !devEntities.length) {\n        return false;\n      }\n      if (\n        !devEntities.some((entity) => {\n          const stateObj = this.hass.states[entity.entity_id];\n          if (!stateObj) {\n            return false;\n          }\n          return (\n            stateObj.attributes.device_class &&\n            this.includeDeviceClasses!.includes(\n              stateObj.attributes.device_class\n            )\n          );\n        })\n      ) {\n        return false;\n      }\n    }\n\n    if (this.deviceFilter) {\n      if (!this.deviceFilter(device)) {\n        return false;\n      }\n    }\n\n    if (this.entityFilter) {\n      if (\n        !devEntities.some((entity) => {\n          const stateObj = this.hass.states[entity.entity_id];\n          if (!stateObj) {\n            return false;\n          }\n          return this.entityFilter!(stateObj);\n        })\n      ) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  private _entityRegMeetsFilter(entity: EntityRegistryDisplayEntry): boolean {\n    if (entity.entity_category) {\n      return false;\n    }\n\n    if (\n      this.includeDomains &&\n      !this.includeDomains.includes(computeDomain(entity.entity_id))\n    ) {\n      return false;\n    }\n    if (this.includeDeviceClasses) {\n      const stateObj = this.hass.states[entity.entity_id];\n      if (!stateObj) {\n        return false;\n      }\n      if (\n        !stateObj.attributes.device_class ||\n        !this.includeDeviceClasses!.includes(stateObj.attributes.device_class)\n      ) {\n        return false;\n      }\n    }\n\n    if (this.entityFilter) {\n      const stateObj = this.hass.states[entity.entity_id];\n      if (!stateObj) {\n        return false;\n      }\n      if (!this.entityFilter!(stateObj)) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  static get styles(): CSSResultGroup {\n    return css`\n      ${unsafeCSS(chipStyles)}\n      .mdc-chip {\n        color: var(--primary-text-color);\n      }\n      .items {\n        z-index: 2;\n      }\n      .mdc-chip-set {\n        padding: 4px 0;\n      }\n      .mdc-chip.add {\n        color: rgba(0, 0, 0, 0.87);\n      }\n      .add-container {\n        position: relative;\n        display: inline-flex;\n      }\n      .mdc-chip:not(.add) {\n        cursor: default;\n      }\n      .mdc-chip ha-icon-button {\n        --mdc-icon-button-size: 24px;\n        display: flex;\n        align-items: center;\n        outline: none;\n      }\n      .mdc-chip ha-icon-button ha-svg-icon {\n        border-radius: 50%;\n        background: var(--secondary-text-color);\n      }\n      .mdc-chip__icon.mdc-chip__icon--trailing {\n        width: 16px;\n        height: 16px;\n        --mdc-icon-size: 14px;\n        color: var(--secondary-text-color);\n        margin-inline-start: 4px !important;\n        margin-inline-end: -4px !important;\n        direction: var(--direction);\n      }\n      .mdc-chip__icon--leading {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        --mdc-icon-size: 20px;\n        border-radius: 50%;\n        padding: 6px;\n        margin-left: -14px !important;\n        margin-inline-start: -14px !important;\n        margin-inline-end: 4px !important;\n        direction: var(--direction);\n      }\n      .expand-btn {\n        margin-right: 0;\n      }\n      .mdc-chip.area_id:not(.add) {\n        border: 2px solid #fed6a4;\n        background: var(--card-background-color);\n      }\n      .mdc-chip.area_id:not(.add) .mdc-chip__icon--leading,\n      .mdc-chip.area_id.add {\n        background: #fed6a4;\n      }\n      .mdc-chip.device_id:not(.add) {\n        border: 2px solid #a8e1fb;\n        background: var(--card-background-color);\n      }\n      .mdc-chip.device_id:not(.add) .mdc-chip__icon--leading,\n      .mdc-chip.device_id.add {\n        background: #a8e1fb;\n      }\n      .mdc-chip.entity_id:not(.add) {\n        border: 2px solid #d2e7b9;\n        background: var(--card-background-color);\n      }\n      .mdc-chip.entity_id:not(.add) .mdc-chip__icon--leading,\n      .mdc-chip.entity_id.add {\n        background: #d2e7b9;\n      }\n      .mdc-chip:hover {\n        z-index: 5;\n      }\n      paper-tooltip.expand {\n        min-width: 200px;\n      }\n      :host([disabled]) .mdc-chip {\n        opacity: var(--light-disabled-opacity);\n        pointer-events: none;\n      }\n      mwc-menu-surface {\n        --mdc-menu-min-width: 100%;\n      }\n      ha-entity-picker,\n      ha-device-picker,\n      ha-area-picker {\n        display: block;\n        width: 100%;\n      }\n    `;\n  }\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"ha-target-picker\": HaTargetPicker;\n  }\n}\n"],"names":[],"sourceRoot":""}