name: Build wheels

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

env:
  WHEELS_TAG: 3.8-alpine3.12

jobs:
  init:
    name: Initialize build
    runs-on: ubuntu-latest
    outputs:
      architectures: ${{ steps.info.outputs.architectures }}
      requirements: ${{ steps.requirements.outputs.changed }}
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Get information
        id: info
        uses: home-assistant/actions/helpers/info@master

      - name: Get changed files
        id: changed_files
        uses: jitterbit/get-changed-files@v1

      - name: Check if requirements files changed
        id: requirements
        run: |
          if [[ "${{ steps.changed_files.outputs.all }}" =~ requrirements.txt ]]; then
            echo "::set-output name=changed::true"
          elif [[ "${{ steps.changed_files.outputs.all }}" =~ requrirements_tests.txt ]]; then
            echo "::set-output name=changed::true"
          fi

  build-wheels:
    name: Build wheels
    needs: init
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: ${{ fromJson(needs.init.outputs.architectures) }}
    steps:
      - name: Checkout the repository
        if: needs.init.outputs.requirements == 'true'
        uses: actions/checkout@v2

      - name: Build wheels
        if: needs.init.outputs.requirements == 'true'
        uses: home-assistant/wheels@action
        with:
          tag: ${{ env.WHEELS_TAG }}
          arch: ${{ matrix.arch }}
          wheels-host: ${{ secrets.WHEELS_HOST }}
          wheels-key: ${{ secrets.WHEELS_KEY }}
          apk: "build-base;libffi-dev;openssl-dev"
          skip-binary: aiohttp
          requirements: "requirements.txt"
